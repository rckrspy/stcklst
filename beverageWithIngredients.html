<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Beverage Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* === Base Styles === */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: row;
            gap: 30px;
        }
        
        .beverage-section {
            flex: 2;
            padding: 25px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-section {
            flex: 1;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            align-self: flex-start;
        }
        
        /* === Header Styles === */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .page-title {
            font-size: 2rem;
            color: #2c3e50;
            margin: 0;
        }
        
        .enterprise-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .enterprise-link:hover {
            transform: translateY(-1px);
            text-decoration: none;
            color: white;
        }
        
        /* === Form Styles === */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        input[type="text"], 
        input[type="number"], 
        select, 
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        /* === Ingredient Selector Styles === */
        .ingredient-selector {
            position: relative;
        }
        
        .ingredient-controls {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .ingredient-dropdown {
            flex: 1;
        }
        
        .add-ingredient-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        .add-ingredient-btn:hover {
            background: #218838;
        }
        
        /* === Modal Styles === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            color: #2c3e50;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #dc3545;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* === Button Styles === */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        /* === Message Styles === */
        .message {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* === Progress Indicator === */
        .progress-indicator {
            background: #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* === Responsive Design === */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .ingredient-controls {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
        
        /* === Loading Spinner === */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* === Dynamic Ingredients Styles === */
        .ingredients-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ingredients-header label {
            margin-bottom: 0;
        }
        
        .btn-sm {
            padding: 5px 12px;
            font-size: 12px;
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
            position: relative;
        }
        
        .ingredient-row.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .drag-handle {
            cursor: grab;
            color: #6c757d;
            font-size: 18px;
            padding: 5px;
            user-select: none;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .ingredient-row-content {
            display: flex;
            flex: 1;
            gap: 10px;
            align-items: center;
        }
        
        .ingredient-select {
            flex: 2;
            min-width: 150px;
        }
        
        .ingredient-brand {
            flex: 1.5;
            min-width: 120px;
            font-size: 13px;
        }
        
        .ingredient-amount {
            flex: 1;
            min-width: 80px;
        }
        
        .ingredient-unit {
            flex: 1;
            min-width: 80px;
        }
        
        .menu-indicator {
            flex: 0 0 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 0;
            font-size: 12px;
            color: #6c757d;
        }
        
        .menu-checkbox {
            margin: 0;
            width: 16px;
            height: 16px;
        }
        
        .checkbox-text {
            font-size: 11px;
            white-space: nowrap;
        }
        
        /* === Help Icon Styles === */
        .help-icon {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .help-icon:hover {
            background: #0056b3;
        }
        
        /* === Help Modal Styles === */
        .help-definition {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .help-definition:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .help-definition h4 {
            color: #2c3e50;
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .help-definition p {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }
        
        .ingredient-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-remove:hover {
            background: #c82333;
        }
        
        .btn-add-new {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .btn-add-new:hover {
            background: #218838;
        }
        
        .ingredients-footer {
            margin-top: 10px;
        }
        
        .text-muted {
            color: #6c757d;
        }
        
        .duplicate-ingredient {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }
        
        .duplicate-ingredient .ingredient-select {
            border-color: #dc3545 !important;
        }
        
        /* === Responsive Design for Ingredients === */
        @media (max-width: 768px) {
            .ingredient-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .ingredient-row-content {
                flex-direction: column;
            }
            
            .ingredient-select,
            .ingredient-amount,
            .ingredient-unit {
                min-width: auto;
            }
            
            .drag-handle {
                align-self: center;
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Beverage Creation Form -->
        <div class="beverage-section">
            <div class="page-header">
                <div>
                    <h1 class="page-title">🍹 Create New Beverage</h1>
                    <div class="version-info" style="font-size: 0.8rem; color: #6c757d; margin-top: 5px;">
                        Version 3.0.0 - Unified Beverage Interface
                    </div>
                </div>
                <a href="https://script.google.com/d/1rpVR1c_8a7RbFy6dmCJa2kSCjgQ_stw-EdpIN4v4F3bRla-szSbZyzy6/edit" 
                   target="_blank" class="enterprise-link">
                    🚀 Enterprise System
                </a>
            </div>
            
            <div id="main-message" class="message"></div>
            <div id="progress-indicator" class="progress-indicator" style="display: none;">
                Your progress is automatically saved as you work.
            </div>
            
            <form id="beverage-form">
                <!-- Basic Beverage Info -->
                <div class="form-group">
                    <label for="beverageName">Beverage Name *</label>
                    <input type="text" id="beverageName" name="beverageName" required 
                           placeholder="e.g., Classic Martini">
                </div>
                
                <div class="form-group">
                    <label for="beverageType">
                        Beverage Type 
                        <button type="button" class="help-icon" onclick="openBeverageTypeHelp()" title="Help">?</button>
                    </label>
                    <select id="beverageType" name="beverageType">
                        <option value="">-- Select Type --</option>
                        
                        <optgroup label="Cocktail">
                            <option value="Classic Cocktail">Classic Cocktail</option>
                            <option value="Modern / Craft Cocktail">Modern / Craft Cocktail</option>
                            <option value="Tiki Cocktail">Tiki Cocktail</option>
                            <option value="Seasonal Cocktail">Seasonal Cocktail</option>
                        </optgroup>
                        
                        <optgroup label="Zero-Proof Cocktail">
                            <option value="Classic Zero-Proof">Classic Zero-Proof</option>
                            <option value="Innovative Zero-Proof">Innovative Zero-Proof</option>
                            <option value="Functional Beverage">Functional Beverage</option>
                        </optgroup>
                        
                        <optgroup label="Mixed Drink">
                            <option value="Simple Mixed Drink">Simple Mixed Drink</option>
                            <option value="Complex Mixed Drink">Complex Mixed Drink</option>
                            <option value="Batched Mixed Drink">Batched Mixed Drink</option>
                        </optgroup>
                        
                        <optgroup label="Beer & Other Fermented">
                            <option value="Draft Beer">Draft Beer</option>
                            <option value="Bottled/Canned Beer">Bottled/Canned Beer</option>
                            <option value="Cider">Cider</option>
                            <option value="Kombucha">Kombucha</option>
                            <option value="Sake">Sake</option>
                        </optgroup>
                        
                        <optgroup label="Wine & Sparkling Wine">
                            <option value="Still Wine">Still Wine</option>
                            <option value="Sparkling Wine">Sparkling Wine</option>
                            <option value="Fortified Wine">Fortified Wine</option>
                            <option value="Wine Cocktail">Wine Cocktail</option>
                        </optgroup>
                        
                        <optgroup label="Spirit Pour (Neat/Rocks)">
                            <option value="Premium Pour">Premium Pour</option>
                            <option value="Well Pour">Well Pour</option>
                            <option value="Aged Spirit">Aged Spirit</option>
                            <option value="Flight/Tasting">Flight/Tasting</option>
                        </optgroup>
                        
                        <option value="Other Beverage">Other Beverage</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="serviceMethod">Service Method</label>
                    <select id="serviceMethod" name="serviceMethod">
                        <option value="">-- Select Service Method --</option>
                        <option value="Individual Service">Individual Service</option>
                        <option value="Draft/Batched">Draft/Batched</option>
                        <option value="Kegged">Kegged</option>
                        <option value="Pre-batched Bottle Service">Pre-batched Bottle Service</option>
                        <option value="Large Format (Pitcher/Carafe)">Large Format (Pitcher/Carafe)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="glassType">Glass Type</label>
                    <select id="glassType" name="glassType">
                        <option value="">-- Select Glass --</option>
                        <option value="Martini">Martini</option>
                        <option value="Rocks">Rocks</option>
                        <option value="Highball">Highball</option>
                        <option value="Shot">Shot</option>
                        <option value="Wine">Wine</option>
                        <option value="Coupe">Coupe</option>
                        <option value="Mug">Mug</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="iceType">Ice Type</label>
                    <select id="iceType" name="iceType">
                        <option value="">-- Select Ice Type --</option>
                        <option value="None (Served Up/Neat)">None (Served Up/Neat)</option>
                        <option value="Regular Cubes">Regular Cubes</option>
                        <option value="Large Cube/Sphere">Large Cube/Sphere</option>
                        <option value="Pebble Ice/Crushed">Pebble Ice/Crushed</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="buildMethod">Build Method</label>
                    <select id="buildMethod" name="buildMethod">
                        <option value="">-- Select Build Method --</option>
                        <option value="Shaken">Shaken</option>
                        <option value="Stirred">Stirred</option>
                        <option value="Built in Glass">Built in Glass</option>
                        <option value="Served Neat/As-Is">Served Neat/As-Is</option>
                        <option value="Blended">Blended</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="popularityRating">Popularity Rating (1-10)</label>
                    <input type="number" id="popularityRating" name="popularityRating" 
                           min="1" max="10" value="5" step="1"
                           title="Rate from 1 (least popular) to 10 (most popular)">
                    <small class="text-muted">Default: 5 (moderate popularity)</small>
                </div>
                
                <!-- Dynamic Ingredients Section -->
                <div class="form-group">
                    <div class="ingredients-header">
                        <label>Recipe Ingredients *</label>
                        <button type="button" class="btn btn-success btn-sm" onclick="addIngredientRow()">
                            ➕ Add Ingredient Row
                        </button>
                    </div>
                    <div id="ingredients-container">
                        <!-- Dynamic ingredient rows will be added here -->
                    </div>
                    <div class="ingredients-footer">
                        <small class="text-muted">At least one ingredient is required. Drag to reorder ingredients.</small>
                    </div>
                </div>
                
                <!-- Additional Info -->
                <div class="form-group">
                    <label for="instructions">Instructions</label>
                    <textarea id="instructions" name="instructions" rows="4" 
                              placeholder="Describe how to prepare this beverage..."></textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <span id="submit-text">Create Beverage</span>
                        <span id="submit-loading" class="loading" style="display: none;"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        Clear Form
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Summary Section -->
        <div class="summary-section">
            <h3>Recipe Summary</h3>
            <div id="recipe-preview">
                <p class="text-muted">Fill out the form to see your recipe preview here.</p>
            </div>
            
            <h4>Quick Actions</h4>
            <button type="button" class="btn btn-success" style="width: 100%; margin-bottom: 10px;" 
                    onclick="openIngredientModal()">
                🆕 Create New Ingredient
            </button>
            
            <div class="progress-indicator">
                <strong>Recent Ingredients:</strong>
                <div id="recent-ingredients">No recent additions</div>
            </div>
        </div>
    </div>
    
    <!-- Add Ingredient Modal -->
    <div id="ingredient-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Ingredient</h3>
                <button type="button" class="close-btn" onclick="closeIngredientModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="ingredient-message" class="message"></div>
                
                <form id="ingredient-form">
                    <div class="form-group">
                        <label for="ingredientName">Ingredient Name *</label>
                        <input type="text" id="ingredientName" name="ingredientName" required 
                               placeholder="Enter ingredient name">
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required>
                            <option value="">-- Select Category --</option>
                            <option value="Vodka">Vodka</option>
                            <option value="Tequila">Tequila</option>
                            <option value="Bourbon">Bourbon</option>
                            <option value="Scotch">Scotch</option>
                            <option value="Gin">Gin</option>
                            <option value="Rum">Rum</option>
                            <option value="Liqueurs/Cordials/Schnapps">Liqueurs/Cordials/Schnapps</option>
                            <option value="Brandy & Cognac">Brandy & Cognac</option>
                            <option value="Mixers & Modifiers">Mixers & Modifiers</option>
                            <option value="Fresh Ingredients">Fresh Ingredients</option>
                            <option value="Garnishes & Accessories">Garnishes & Accessories</option>
                            <option value="Wine">Wine</option>
                            <option value="Beer">Beer</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="labelBrand">Brand/Label</label>
                        <input type="text" id="labelBrand" name="labelBrand" 
                               placeholder="Brand or label name">
                    </div>
                    
                    <div class="form-group">
                        <label for="abv">ABV (%)</label>
                        <input type="number" id="abv" name="abv" step="0.1" min="0" max="100" 
                               placeholder="Alcohol by volume percentage">
                    </div>
                    
                    <div class="form-group">
                        <label for="costPerUnit">Cost Per Unit ($)</label>
                        <input type="number" id="costPerUnit" name="costPerUnit" step="0.01" min="0" 
                               placeholder="Cost per bottle/unit">
                    </div>
                    
                    <div class="form-group">
                        <label for="unitSize">Unit Size</label>
                        <input type="text" id="unitSize" name="unitSize" 
                               placeholder="e.g., 750ml, 1L">
                    </div>
                    
                    <div class="form-group">
                        <label for="unitMetric">Unit Metric</label>
                        <select id="unitMetric" name="unitMetric">
                            <option value="ml">ml</option>
                            <option value="L">L</option>
                            <option value="oz">oz</option>
                            <option value="each">each</option>
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">
                            <span id="ingredient-submit-text">Add Ingredient</span>
                            <span id="ingredient-submit-loading" class="loading" style="display: none;"></span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeIngredientModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Beverage Type Help Modal -->
    <div id="beverage-type-help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Beverage Type Definitions</h3>
                <button type="button" class="close-btn" onclick="closeBeverageTypeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-definition">
                    <h4>Cocktail</h4>
                    <p>A handcrafted alcoholic beverage made with two or more ingredients, typically a spirit mixed with mixers, juices, or syrups. (e.g., Margarita, Old Fashioned, Martini)</p>
                </div>
                
                <div class="help-definition">
                    <h4>Zero-Proof Cocktail</h4>
                    <p>A sophisticated, non-alcoholic drink crafted to have the complexity and flavor profile of a cocktail, but without any alcohol. (e.g., a "spirit-free" gin & tonic)</p>
                </div>
                
                <div class="help-definition">
                    <h4>Mocktail</h4>
                    <p>A non-alcoholic mixed drink, often a simple combination of juices, sodas, and garnishes.</p>
                </div>
                
                <div class="help-definition">
                    <h4>Mixed Drink</h4>
                    <p>A simple alcoholic beverage made with a spirit and a single mixer. (e.g., Rum and Coke, Gin and Tonic, Vodka Soda)</p>
                </div>
                
                <div class="help-definition">
                    <h4>Beer & Other Fermented</h4>
                    <p>Includes all types of beer, ciders, and hard seltzers.</p>
                </div>
                
                <div class="help-definition">
                    <h4>Wine & Sparkling Wine</h4>
                    <p>Still wines (red, white, rosé) and sparkling wines (champagne, prosecco, cava, etc.).</p>
                </div>
                
                <div class="help-definition">
                    <h4>Spirit Pour (Neat/Rocks)</h4>
                    <p>Liquor served by itself, either at room temperature (Neat) or over ice (On the Rocks).</p>
                </div>
                
                <div class="help-definition">
                    <h4>Other Beverage</h4>
                    <p>Any other beverage not included in a category above. (e.g., bottled water, tea, coffee, energy drinks)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTargetDropdown = null;
        let availableIngredients = [];
        let baseSpirits = [];
        let ingredientCounter = 0;
        let ingredientsData = [];
        
        // Safe initialization of ingredient data
        try {
            const ingredientNamesData = <?= JSON.stringify(ingredientNames || []) ?>;
            const baseSpiritsData = <?= JSON.stringify(baseSpirits || []) ?>;
            
            availableIngredients = Array.isArray(ingredientNamesData) ? ingredientNamesData : [];
            baseSpirits = Array.isArray(baseSpiritsData) ? baseSpiritsData : [];
            
            console.log('Ingredients loaded:', availableIngredients.length, 'Base spirits loaded:', baseSpirits.length);
        } catch (error) {
            console.error('Error loading ingredient data:', error);
            availableIngredients = [];
            baseSpirits = [];
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeIngredientsSection();
            loadSavedProgress();
            updateRecipePreview();
            
            // Auto-save progress as user types
            const formElements = document.querySelectorAll('#beverage-form input, #beverage-form select, #beverage-form textarea');
            formElements.forEach(element => {
                element.addEventListener('input', function() {
                    saveProgress();
                    updateRecipePreview();
                });
            });
        });
        
        // === Dynamic Ingredients Management === 
        
        /**
         * Initialize ingredients section with one default row
         */
        function initializeIngredientsSection() {
            // Add first ingredient row by default
            addIngredientRow();
        }
        
        /**
         * Add a new ingredient row
         */
        function addIngredientRow(ingredient = null) {
            const container = document.getElementById('ingredients-container');
            const rowId = 'ingredient-row-' + (++ingredientCounter);
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'ingredient-row';
            rowDiv.setAttribute('data-row-id', rowId);
            rowDiv.draggable = true;
            
            rowDiv.innerHTML = `
                <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
                <div class="ingredient-row-content">
                    <select class="ingredient-select" name="ingredient-${ingredientCounter}" 
                            onchange="updateIngredientsData(); saveProgress(); updateRecipePreview();">
                        <option value="">-- Select Ingredient --</option>
                        ${(availableIngredients || []).map(ing => 
                            `<option value="${ing}" ${ingredient && ingredient.name === ing ? 'selected' : ''}>${ing}</option>`
                        ).join('')}
                    </select>
                    <input type="text" class="ingredient-brand" name="brand-${ingredientCounter}" 
                           placeholder="Preferred Brand" 
                           value="${ingredient ? ingredient.preferredBrand || '' : ''}"
                           onchange="updateIngredientsData(); saveProgress(); updateRecipePreview();">
                    <input type="number" class="ingredient-amount" name="amount-${ingredientCounter}" 
                           placeholder="Amount" step="0.0625" min="0" 
                           value="${ingredient ? ingredient.amount || '' : ''}"
                           onchange="updateIngredientsData(); saveProgress(); updateRecipePreview();">
                    <select class="ingredient-unit" name="unit-${ingredientCounter}" 
                            onchange="updateIngredientsData(); saveProgress(); updateRecipePreview();">
                        <option value="oz" ${ingredient && ingredient.unit === 'oz' ? 'selected' : ''}>oz</option>
                        <option value="ml" ${ingredient && ingredient.unit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="cups" ${ingredient && ingredient.unit === 'cups' ? 'selected' : ''}>cups</option>
                        <option value="tsp" ${ingredient && ingredient.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                        <option value="tbsp" ${ingredient && ingredient.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                        <option value="dashes" ${ingredient && ingredient.unit === 'dashes' ? 'selected' : ''}>dashes</option>
                        <option value="splash" ${ingredient && ingredient.unit === 'splash' ? 'selected' : ''}>splash</option>
                        <option value="each" ${ingredient && ingredient.unit === 'each' ? 'selected' : ''}>each</option>
                    </select>
                    <div class="menu-indicator">
                        <label class="checkbox-label">
                            <input type="checkbox" class="menu-checkbox" name="menu-${ingredientCounter}" 
                                   ${ingredient && ingredient.showOnMenu !== false ? 'checked' : 'checked'}
                                   onchange="updateIngredientsData(); saveProgress(); updateRecipePreview();">
                            <span class="checkbox-text">Menu</span>
                        </label>
                    </div>
                </div>
                <div class="ingredient-actions">
                    <button type="button" class="btn-remove" onclick="removeIngredientRow('${rowId}')">
                        ✕
                    </button>
                </div>
            `;
            
            container.appendChild(rowDiv);
            
            // Add drag and drop functionality
            setupDragAndDrop(rowDiv);
            
            // Update ingredients data
            updateIngredientsData();
        }
        
        /**
         * Remove an ingredient row
         */
        function removeIngredientRow(rowId) {
            const row = document.querySelector(`[data-row-id="${rowId}"]`);
            if (row) {
                // Don't allow removing the last ingredient
                const remainingRows = document.querySelectorAll('.ingredient-row').length;
                if (remainingRows <= 1) {
                    alert('At least one ingredient is required for a beverage.');
                    return;
                }
                
                // Check if row has data before confirming
                const hasData = checkRowHasData(row);
                if (hasData) {
                    if (!confirm('This ingredient row has data. Are you sure you want to remove it?')) {
                        return;
                    }
                }
                
                row.remove();
                updateIngredientsData();
                saveProgress();
                updateRecipePreview();
            }
        }
        
        /**
         * Check if ingredient row has any data
         */
        function checkRowHasData(row) {
            const select = row.querySelector('.ingredient-select');
            const brand = row.querySelector('.ingredient-brand');
            const amount = row.querySelector('.ingredient-amount');
            
            return (select && select.value) || 
                   (brand && brand.value.trim()) || 
                   (amount && amount.value);
        }
        
        /**
         * Update ingredients data array from DOM
         */
        function updateIngredientsData() {
            ingredientsData = [];
            const rows = document.querySelectorAll('.ingredient-row');
            
            rows.forEach((row, index) => {
                const select = row.querySelector('.ingredient-select');
                const brand = row.querySelector('.ingredient-brand');
                const amount = row.querySelector('.ingredient-amount');
                const unit = row.querySelector('.ingredient-unit');
                const menuCheckbox = row.querySelector('.menu-checkbox');
                
                if (select.value) { // Only include rows with selected ingredients
                    ingredientsData.push({
                        name: select.value,
                        preferredBrand: brand ? brand.value : '',
                        amount: parseFloat(amount.value) || 0,
                        unit: unit.value,
                        showOnMenu: menuCheckbox ? menuCheckbox.checked : true,
                        order: index + 1
                    });
                }
            });
            
            // Check for duplicates and highlight them
            validateIngredients();
        }
        
        /**
         * Validate ingredients and check for duplicates
         */
        function validateIngredients() {
            const rows = document.querySelectorAll('.ingredient-row');
            const ingredientCounts = {};
            
            // Clear previous validation styles
            rows.forEach(row => {
                row.classList.remove('duplicate-ingredient');
                const select = row.querySelector('.ingredient-select');
                select.style.borderColor = '';
                select.title = '';
            });
            
            // Count ingredient occurrences
            rows.forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const ingredientName = select.value;
                
                if (ingredientName) {
                    ingredientCounts[ingredientName] = (ingredientCounts[ingredientName] || 0) + 1;
                }
            });
            
            // Highlight duplicates
            rows.forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const ingredientName = select.value;
                
                if (ingredientName && ingredientCounts[ingredientName] > 1) {
                    row.classList.add('duplicate-ingredient');
                    select.style.borderColor = '#dc3545';
                    select.title = `Warning: ${ingredientName} appears ${ingredientCounts[ingredientName]} times in this recipe`;
                }
            });
            
            return Object.values(ingredientCounts).some(count => count > 1);
        }
        
        /**
         * Validate ingredient amounts
         */
        function validateIngredientAmounts() {
            const rows = document.querySelectorAll('.ingredient-row');
            let hasErrors = false;
            
            rows.forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const amount = row.querySelector('.ingredient-amount');
                
                // Clear previous validation
                amount.style.borderColor = '';
                amount.title = '';
                
                if (select.value && (!amount.value || parseFloat(amount.value) <= 0)) {
                    amount.style.borderColor = '#dc3545';
                    amount.title = 'Amount must be greater than 0';
                    hasErrors = true;
                }
            });
            
            return hasErrors;
        }
        
        /**
         * Setup drag and drop for ingredient rows
         */
        function setupDragAndDrop(row) {
            row.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', '');
                this.classList.add('dragging');
            });
            
            row.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                updateIngredientsData();
                saveProgress();
                updateRecipePreview();
            });
            
            row.addEventListener('dragover', function(e) {
                e.preventDefault();
                const draggingElement = document.querySelector('.dragging');
                const siblings = [...this.parentNode.querySelectorAll('.ingredient-row:not(.dragging)')];
                
                const nextSibling = siblings.find(sibling => {
                    return e.clientY <= sibling.offsetTop + sibling.offsetHeight / 2;
                });
                
                this.parentNode.insertBefore(draggingElement, nextSibling);
            });
        }
        
        // Progress saving/loading
        function saveProgress() {
            const formData = new FormData(document.getElementById('beverage-form'));
            const progress = {};
            
            // Save basic form data (excluding dynamic ingredient fields)
            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('ingredient-') && !key.startsWith('amount-') && !key.startsWith('unit-')) {
                    progress[key] = value;
                }
            }
            
            // Save dynamic ingredients data
            updateIngredientsData();
            progress.ingredients = ingredientsData;
            
            localStorage.setItem('beverageProgress', JSON.stringify(progress));
            document.getElementById('progress-indicator').style.display = 'block';
        }
        
        function loadSavedProgress() {
            const saved = localStorage.getItem('beverageProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                
                // Load basic form fields
                Object.keys(progress).forEach(key => {
                    if (key !== 'ingredients') {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = progress[key];
                        }
                    }
                });
                
                // Load dynamic ingredients
                if (progress.ingredients && progress.ingredients.length > 0) {
                    // Clear existing rows first
                    const container = document.getElementById('ingredients-container');
                    container.innerHTML = '';
                    ingredientCounter = 0;
                    ingredientsData = [];
                    
                    // Add saved ingredients
                    progress.ingredients.forEach(ingredient => {
                        addIngredientRow(ingredient);
                    });
                    
                    updateIngredientsData();
                }
                
                document.getElementById('progress-indicator').style.display = 'block';
            }
        }
        
        function clearProgress() {
            localStorage.removeItem('beverageProgress');
            document.getElementById('progress-indicator').style.display = 'none';
        }
        
        // Update recipe preview
        function updateRecipePreview() {
            const form = document.getElementById('beverage-form');
            const formData = new FormData(form);
            
            // Update ingredients data before preview
            updateIngredientsData();
            
            let preview = '<div>';
            
            const name = formData.get('beverageName');
            if (name) {
                preview += `<h4>${name}</h4>`;
            }
            
            const type = formData.get('beverageType');
            if (type) {
                preview += `<p><strong>Type:</strong> ${type}</p>`;
            }
            
            const serviceMethod = formData.get('serviceMethod');
            if (serviceMethod) {
                preview += `<p><strong>Service:</strong> ${serviceMethod}</p>`;
            }
            
            const buildMethod = formData.get('buildMethod');
            if (buildMethod) {
                preview += `<p><strong>Build Method:</strong> ${buildMethod}</p>`;
            }
            
            const iceType = formData.get('iceType');
            if (iceType) {
                preview += `<p><strong>Ice:</strong> ${iceType}</p>`;
            }
            
            const glass = formData.get('glassType');
            if (glass) {
                preview += `<p><strong>Glass:</strong> ${glass}</p>`;
            }
            
            const popularity = formData.get('popularityRating');
            if (popularity) {
                const stars = '★'.repeat(parseInt(popularity)) + '☆'.repeat(10 - parseInt(popularity));
                preview += `<p><strong>Popularity:</strong> ${popularity}/10 ${stars}</p>`;
            }
            
            // Display dynamic ingredients
            preview += '<h5>Ingredients:</h5>';
            if (ingredientsData.length > 0) {
                preview += '<ul>';
                ingredientsData.forEach(ingredient => {
                    const amount = ingredient.amount > 0 ? ingredient.amount : '?';
                    const brand = ingredient.preferredBrand ? ` (${ingredient.preferredBrand})` : '';
                    const menuIndicator = ingredient.showOnMenu ? '📋' : '';
                    preview += `<li>${amount} ${ingredient.unit} ${ingredient.name}${brand} ${menuIndicator}</li>`;
                });
                preview += '</ul>';
                
                // Enhanced Menu Summary - always show when items are marked for menu
                const menuItems = ingredientsData.filter(ing => ing.showOnMenu);
                if (menuItems.length > 0) {
                    preview += '<div style="background: #e8f4fd; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #2196F3;">';
                    preview += '<h6 style="margin: 0 0 5px 0; color: #0c5460;"><strong>📋 Menu Summary</strong></h6>';
                    preview += '<p style="margin: 0; font-size: 14px;">';
                    preview += menuItems.map(ing => ing.name).join(', ');
                    preview += '</p></div>';
                }
            } else {
                preview += '<p class="text-muted">No ingredients added yet.</p>';
            }
            
            const instructions = formData.get('instructions');
            if (instructions) {
                preview += `<p><strong>Instructions:</strong> ${instructions}</p>`;
            }
            
            preview += '</div>';
            
            if (!name && ingredientsData.length === 0) {
                preview = '<p class="text-muted">Fill out the form to see your recipe preview here.</p>';
            }
            
            document.getElementById('recipe-preview').innerHTML = preview;
        }
        
        // Modal functions
        function openIngredientModal(targetDropdown = null) {
            currentTargetDropdown = targetDropdown;
            document.getElementById('ingredient-modal').style.display = 'block';
            document.getElementById('ingredientName').focus();
            
            // Pre-populate category if we can infer from context
            const type = document.getElementById('beverageType').value;
            if (type === 'Cocktail') {
                // Suggest spirit category for cocktails
                document.getElementById('category').value = 'Gin';
            }
        }
        
        function closeIngredientModal() {
            document.getElementById('ingredient-modal').style.display = 'none';
            document.getElementById('ingredient-form').reset();
            hideMessage('ingredient-message');
            currentTargetDropdown = null;
        }
        
        // Help modal functions
        function openBeverageTypeHelp() {
            document.getElementById('beverage-type-help-modal').style.display = 'block';
        }
        
        function closeBeverageTypeHelp() {
            document.getElementById('beverage-type-help-modal').style.display = 'none';
        }
        
        // Message functions
        function showMessage(elementId, message, type = 'info') {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => hideMessage(elementId), 5000);
            }
        }
        
        function hideMessage(elementId) {
            const messageElement = document.getElementById(elementId);
            messageElement.style.display = 'none';
        }
        
        // Form submission functions
        document.getElementById('beverage-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate ingredients
            updateIngredientsData();
            if (ingredientsData.length === 0) {
                showMessage('main-message', 'At least one ingredient is required.', 'error');
                return;
            }
            
            // Check for validation errors
            const hasAmountErrors = validateIngredientAmounts();
            const hasDuplicates = validateIngredients();
            
            if (hasAmountErrors) {
                showMessage('main-message', 'Please fix ingredient amount errors (red borders).', 'error');
                return;
            }
            
            // Check for missing ingredient data
            const incompleteIngredients = ingredientsData.filter(ing => !ing.name || ing.amount <= 0);
            if (incompleteIngredients.length > 0) {
                showMessage('main-message', 'Please fill in all ingredient details (name and amount).', 'error');
                return;
            }
            
            // Warn about duplicates but allow submission
            if (hasDuplicates) {
                if (!confirm('Warning: This recipe contains duplicate ingredients. Do you want to continue?')) {
                    return;
                }
            }
            
            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';
            
            const formData = new FormData(this);
            const beverageData = {};
            
            // Collect basic form data (excluding ingredient fields)
            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('ingredient-') && !key.startsWith('amount-') && !key.startsWith('unit-')) {
                    beverageData[key] = value;
                }
            }
            
            // Add ingredients array
            beverageData.ingredients = ingredientsData;
            
            console.log('Submitting beverage data:', beverageData);
            
            // Call server function to save beverage
            google.script.run
                .withSuccessHandler(function(result) {
                    showMessage('main-message', 'Beverage created successfully!', 'success');
                    clearForm();
                    clearProgress();
                    
                    submitText.style.display = 'inline';
                    submitLoading.style.display = 'none';
                })
                .withFailureHandler(function(error) {
                    showMessage('main-message', 'Error creating beverage: ' + error.message, 'error');
                    
                    submitText.style.display = 'inline';
                    submitLoading.style.display = 'none';
                })
                .saveBeverageData(beverageData);
        });
        
        document.getElementById('ingredient-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitText = document.getElementById('ingredient-submit-text');
            const submitLoading = document.getElementById('ingredient-submit-loading');
            
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';
            
            const formData = new FormData(this);
            const ingredientData = {};
            for (let [key, value] of formData.entries()) {
                ingredientData[key] = value;
            }
            
            // Call server function to save ingredient
            google.script.run
                .withSuccessHandler(function(result) {
                    showMessage('ingredient-message', 'Ingredient added successfully!', 'success');
                    
                    // Add to available ingredients
                    const newIngredient = ingredientData.ingredientName;
                    if (!availableIngredients.includes(newIngredient)) {
                        availableIngredients.push(newIngredient);
                        availableIngredients.sort();
                    }
                    
                    // Update all dropdowns
                    updateIngredientDropdowns();
                    
                    // Auto-select in target dropdown if specified
                    if (currentTargetDropdown) {
                        const targetElement = document.querySelector(`[name="${currentTargetDropdown}"]`);
                        if (targetElement) {
                            targetElement.value = newIngredient;
                            updateIngredientsData();
                            saveProgress();
                            updateRecipePreview();
                        }
                    }
                    
                    // Update recent ingredients
                    updateRecentIngredients(newIngredient);
                    
                    setTimeout(() => {
                        closeIngredientModal();
                    }, 1500);
                    
                    submitText.style.display = 'inline';
                    submitLoading.style.display = 'none';
                })
                .withFailureHandler(function(error) {
                    showMessage('ingredient-message', 'Error adding ingredient: ' + error.message, 'error');
                    
                    submitText.style.display = 'inline';
                    submitLoading.style.display = 'none';
                })
                .saveIngredientData(ingredientData);
        });
        
        // Update ingredient dropdowns
        function updateIngredientDropdowns() {
            const dropdowns = document.querySelectorAll('.ingredient-select');
            
            dropdowns.forEach(dropdown => {
                const currentValue = dropdown.value;
                
                // Clear and rebuild options
                dropdown.innerHTML = '<option value="">-- Select Ingredient --</option>';
                
                availableIngredients.forEach(ingredient => {
                    const option = document.createElement('option');
                    option.value = ingredient;
                    option.textContent = ingredient;
                    dropdown.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (availableIngredients.includes(currentValue)) {
                    dropdown.value = currentValue;
                }
            });
        }
        
        // Update recent ingredients display
        function updateRecentIngredients(newIngredient) {
            let recent = JSON.parse(localStorage.getItem('recentIngredients') || '[]');
            
            // Add new ingredient if provided and valid
            if (newIngredient && typeof newIngredient === 'string' && newIngredient.trim()) {
                // Add to the beginning and remove duplicates
                recent = recent.filter(ing => ing !== newIngredient);
                recent.unshift(newIngredient);
            }
            
            // Filter out null, undefined, empty strings
            recent = recent.filter(ing => ing && typeof ing === 'string' && ing.trim());
            
            // Keep only the last 5
            recent = recent.slice(0, 5);
            
            localStorage.setItem('recentIngredients', JSON.stringify(recent));
            
            // Update display
            const recentDiv = document.getElementById('recent-ingredients');
            if (recent.length > 0) {
                recentDiv.innerHTML = recent.map(ing => `<div style="padding: 2px 0;">• ${ing}</div>`).join('');
            } else {
                recentDiv.textContent = 'No recent additions';
            }
        }
        
        // Load recent ingredients on page load
        document.addEventListener('DOMContentLoaded', function() {
            const recent = JSON.parse(localStorage.getItem('recentIngredients') || '[]');
            updateRecentIngredients();
        });
        
        // Clear form function
        function clearForm() {
            // Check if form has any data
            const hasFormData = checkFormHasData();
            if (hasFormData) {
                if (!confirm('This form has data. Are you sure you want to clear everything?')) {
                    return;
                }
            }
            
            document.getElementById('beverage-form').reset();
            
            // Clear dynamic ingredients
            const container = document.getElementById('ingredients-container');
            container.innerHTML = '';
            ingredientCounter = 0;
            ingredientsData = [];
            
            // Add back one default ingredient row
            addIngredientRow();
            
            updateRecipePreview();
            hideMessage('main-message');
        }
        
        /**
         * Check if form has any data
         */
        function checkFormHasData() {
            const form = document.getElementById('beverage-form');
            const formData = new FormData(form);
            
            // Check basic form fields
            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('ingredient-') && !key.startsWith('amount-') && 
                    !key.startsWith('unit-') && !key.startsWith('brand-') && 
                    !key.startsWith('menu-') && value && value.trim()) {
                    return true;
                }
            }
            
            // Check if there are any ingredient rows with data
            const rows = document.querySelectorAll('.ingredient-row');
            for (let row of rows) {
                if (checkRowHasData(row)) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const ingredientModal = document.getElementById('ingredient-modal');
            const helpModal = document.getElementById('beverage-type-help-modal');
            
            if (event.target === ingredientModal) {
                closeIngredientModal();
            }
            if (event.target === helpModal) {
                closeBeverageTypeHelp();
            }
        }
    </script>
</body>
</html>